{% extends "base.html" %}
{% block content %}
<style>
  .sidebar, header { display: none !important; }
  body, .main-content {
    margin: 0 !important;
    padding: 0 !important;
    background-color: #f8f9fa;
  }
  .pos-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  .pos-header {
    background-color: #0d6efd;
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .pos-body {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  .pos-products {
    flex: 2;
    padding: 15px;
    overflow-y: auto;
    background: white;
    border-right: 1px solid #dee2e6;
  }
  .pos-cart {
    flex: 1;
    background-color: #f8f9fa;
    padding: 15px;
    display: flex;
    flex-direction: column;
  }
  .product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 8px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.15s ease;
  }
  .product-card:hover {
    transform: scale(1.03);
    background-color: #f1f1f1;
  }
  .cart-list {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  /* Calculator popup */
  #calcModal .modal-content {
    border-radius: 12px;
  }
  .calc-btn {
    width: 70px;
    height: 70px;
    font-size: 1.5rem;
    margin: 4px;
  }
  /* Receipt popup */
  #receiptModal pre {
    font-family: monospace;
    white-space: pre-wrap;
  }

  /* --- ADD THIS CSS INSIDE YOUR <style> TAG --- */

  /* Style for the receipt popup */
  #receiptModal .modal-dialog {
    max-width: 450px; /* A bit wider for the receipt */
  }
  #receiptModal .modal-content {
    border: 2px solid #000;
  }
  #receiptModal .modal-header {
    border-bottom: 2px solid #000;
    padding: 0.75rem 1.25rem;
  }
  #receiptModal .modal-title {
    font-weight: bold;
    text-transform: uppercase;
    font-size: 1.2rem;
  }

  /* This is the main receipt body style */
  #receiptTemplate {
    font-family: 'Courier New', Courier, monospace;
    background: #fdfdfa; /* Off-white paper color */
    border: 1px dashed #999;
    padding: 15px;
    font-size: 14px;
    color: #000;
  }
  #receiptTemplate hr {
    border-top: 1px dashed #000;
    margin: 10px 0;
  }
  .receipt-header {
    text-align: center;
    margin-bottom: 10px;
  }
  .receipt-header h5 {
    margin: 0;
    font-weight: bold;
    text-transform: uppercase;
  }
  .receipt-header small {
    font-size: 13px;
  }
  .receipt-field {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    border-bottom: 1px dotted #777;
  }
  .receipt-field strong {
    margin-right: 10px;
  }
  .receipt-items-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    border-bottom: 1px solid #000;
    margin-top: 15px;
  }
  .receipt-item {
    display: flex;
    margin-top: 5px;
  }
  .receipt-item .item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .receipt-item .item-qty, .receipt-item .item-total {
    text-align: right;
  }
  .receipt-item .item-qty { width: 70px; }
  .receipt-item .item-total { width: 90px; }

  .receipt-totals {
    margin-top: 15px;
  }
  .receipt-totals div {
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  /* --- END OF NEW CSS --- */
</style>

<div class="pos-container">
  <div class="pos-header">
    <h2><i class="bi bi-cart3 me-2"></i>Point of Sale</h2>
    <a href="{{ url_for('core.index') }}" class="btn btn-light btn-sm">
      <i class="bi bi-box-arrow-left me-1"></i> Exit POS
    </a>
  </div>

  <div class="pos-body">
    <div class="pos-products">
  <form id="posSearchForm" method="GET" action="{{ url_for('core.pos') }}" class="mb-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Products</h5>
      <div class="input-group" style="width: 300px;">
        <input type="text" name="search" value="{{ search }}" class="form-control form-control-sm" placeholder="Search product...">
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="bi bi-search"></i> Search
        </button>
      </div>
    </div>
  </form>
  
  <div id="productGrid" class="row row-cols-2 row-cols-md-3 g-2">
    {% for p in products %}
    <div class="col product-col">
      <div class="product-card" data-sku="{{ p.sku }}" data-name="{{ p.name }}" data-price="{{ p.sale_price }}" data-stock="{{ p.quantity }}">
        <strong>{{ p.name }}</strong><br>
        <small>{{ p.sku }}</small><br>
        <span class="badge bg-success">₱{{ "%.2f"|format(p.sale_price) }}</span>
        <br><span class="badge bg-info text-dark product-quantity">Stock: {{ p.quantity }}</span>
      </div>
    </div>
    {% endfor %}
  </div>

  {% include '_pagination.html' %}
</div>

    <div class="pos-cart">
      <h5><i class="bi bi-receipt me-1"></i>Current Sale</h5>
      <div class="cart-list" id="cartList"></div>

      <!-- Document type removed from UI. System will use 'Invoice' as default document type. -->
      <div class="mb-2">
        <h6 class="mb-1" style="font-size: 0.9rem;">Document: <strong>Invoice</strong></h6>
        <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" value="1" id="saleIsVatable">
        <label class="form-check-label" for="saleIsVatable" style="font-size:0.9rem;">
          Vatable sale (12%)
        </label>
        <small class="text-muted d-block">Uncheck for Non‑VAT sale</small>
      </div>
      <div>
        <h6>Total: ₱<span id="total">0.00</span></h6>
        <button id="checkoutBtn" class="btn btn-primary w-100 mt-2">
          <i class="bi bi-cash-coin me-1"></i> Checkout
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="qtyModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qtyModalLabel">Enter Quantity</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="qtyInput" class="form-label">Quantity:</label>
        <input type="number" class="form-control" id="qtyInput" value="1" min="0">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveQtyBtn">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="calcModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content shadow-lg border-0" style="border-radius: 1rem;">
      <div class="modal-body p-4">
        
        <h5 class="text-center text-primary fw-bold mb-3">Enter Cash Tendered</h5>
        
        <input type="text" id="cashInput" class="form-control form-control-lg text-end fs-3 mb-3" readonly placeholder="0.00">
        
        <div class="container-fluid p-0">
          <div class="row g-2">
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('7')">7</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('8')">8</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('9')">9</button></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('4')">4</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('5')">5</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('6')">6</button></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('1')">1</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('2')">2</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('3')">3</button></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-4"><button class="btn btn-lg btn-outline-warning w-100 py-3" onclick="press('C')">C</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('0')">0</button></div>
            <div class="col-4"><button class="btn btn-lg btn-outline-secondary w-100 py-3" onclick="press('.')">.</button></div>
          </div>
          
          <div class="row g-2 mt-3">
             <div class="col-12">
               <button class="btn btn-lg btn-success w-100 py-3" onclick="finishCheckout()">
                 <i class="bi bi-check-lg"></i> OK
               </button>
             </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="receiptTemplate"></div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-secondary" id="printReceiptBtn">
          <i class="bi bi-printer"></i> Print
        </button>
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          <i class="bi bi-check-lg"></i> Done
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// --- REFACTOR: Wrap all JS in a DOMContentLoaded event listener ---
document.addEventListener("DOMContentLoaded", function() {

  let cart = [];
  let cashTendered = 0;
  // --- Get a reference to the quantity modal
  const qtyModalEl = document.getElementById('qtyModal');
  if (!qtyModalEl) {
    console.error("Quantity modal element not found!");
    return;
  }
  const qtyModal = new bootstrap.Modal(qtyModalEl);

  function renderCart() {
  const list = document.getElementById('cartList');
  list.innerHTML = ''; // Clear existing list
  let total = 0;

  cart.forEach((item, i) => {
    total += item.price * item.qty;

    // Create wrapper div
    const row = document.createElement('div');
    row.className = 'd-flex justify-content-between align-items-center border-bottom py-1';

    // Left side: product name and qty × price
    const left = document.createElement('div');
    const nameEl = document.createElement('strong');
    nameEl.textContent = item.name; // Safe text only
    const br = document.createElement('br');
    const qtyEl = document.createElement('small');
    qtyEl.textContent = `${item.qty} × ₱${item.price.toFixed(2)}`;

    left.append(nameEl, br, qtyEl);

    // Delete button
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-outline-danger';
    btn.innerHTML = '<i class="bi bi-trash"></i>';
    btn.addEventListener('click', () => removeItem(i));

    row.append(left, btn);
    list.append(row);
  });

  document.getElementById('total').innerText = total.toFixed(2);
}


  // Make this function global so the inline onclick can find it
  window.removeItem = function(i) {
    cart.splice(i, 1);
    renderCart();
  }

  // --- Product card click listener
  document.querySelectorAll('.product-card').forEach(el => {
    el.addEventListener('click', () => {
      const sku = el.dataset.sku;
      const name = el.dataset.name;
      const price = parseFloat(el.dataset.price);
      const stock = parseInt(el.dataset.stock, 10);
      
      const existing = cart.find(i => i.sku === sku);
      const currentQtyInCart = existing ? existing.qty : 0;

      // Set up the modal
      document.getElementById('qtyModalLabel').innerText = name;
      const qtyInput = document.getElementById('qtyInput');
      qtyInput.value = existing ? existing.qty : 1; // Show current cart qty or default to 1
      qtyInput.max = stock; // Set max stock
      
      // Store product info on the save button
      const saveBtn = document.getElementById('saveQtyBtn');
      saveBtn.dataset.sku = sku;
      saveBtn.dataset.name = name;
      saveBtn.dataset.price = price;
      saveBtn.dataset.stock = stock;
      
      // Show the modal
      qtyModal.show();
    });
  });

  // --- Click listener for the modal's save button
  document.getElementById('saveQtyBtn').addEventListener('click', function() {
    const newQty = parseInt(document.getElementById('qtyInput').value, 10);
    const sku = this.dataset.sku;
    const name = this.dataset.name;
    const price = parseFloat(this.dataset.price);
    const stock = parseInt(this.dataset.stock, 10);
    
    if (isNaN(newQty)) {
      alert('Please enter a valid number.');
      return;
    }
    
    if (newQty > stock) {
      alert(`Not enough stock. Only ${stock} available.`);
      return;
    }

    const existingIndex = cart.findIndex(i => i.sku === sku);

    if (newQty > 0) {
      if (existingIndex > -1) {
        cart[existingIndex].qty = newQty; // Update existing quantity
      } else {
        cart.push({ sku, name, price, qty: newQty }); // Add as new item
      }
    } else {
      // If user enters 0 or less, remove the item
      if (existingIndex > -1) {
        window.removeItem(existingIndex); // Use the global remove function
      }
    }
    
    renderCart();
    qtyModal.hide();
  });


  // --- Calculator Logic ---
  // Make these functions global so inline onclicks can find them
  window.press = function(val) {
    const inp = document.getElementById('cashInput');
    if (val === 'C') inp.value = '';
    else inp.value += val;
  }

  document.getElementById('checkoutBtn').addEventListener('click', () => {
    if (cart.length === 0) return alert('No items in cart.');
    const modal = new bootstrap.Modal(document.getElementById('calcModal'));
    modal.show();
  });

  window.finishCheckout = async function() {
    const total = parseFloat(document.getElementById('total').innerText);
    const cash = parseFloat(document.getElementById('cashInput').value || 0);
    if (isNaN(cash) || cash < total) {
      alert('Insufficient cash.');
      return;
    }

    // Default document type now fixed to 'Invoice'
    const selectedDocType = 'Invoice';

    const saleIsVatable = document.getElementById('saleIsVatable').checked;
    const response = await fetch('/api/sale', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: cart, doc_type: selectedDocType, is_vatable: saleIsVatable, discount_percent: parseFloat(document.getElementById('discountPercent')?.value || 0) })
    });

    const data = await response.json();
    if (data.status === 'ok') {
      const change = cash - total;
      const receipt = generateReceipt(cart, total, cash, change, data.receipt_number || data.sale_id, data.vat);
      document.getElementById('receiptTemplate').innerHTML = receipt;
      new bootstrap.Modal(document.getElementById('receiptModal')).show();
      
      updateStockOnPage(cart); 
      
      cart = [];
      renderCart();
      document.getElementById('cashInput').value = '';
      bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide();
    } else {
      alert(data.error || 'Error during checkout.');
    }
  }

  function updateStockOnPage(cartItems) {
    for (const item of cartItems) {
      const productCard = document.querySelector(`.product-card[data-sku="${item.sku}"]`);
      if (productCard) {
        const qtySpan = productCard.querySelector('.product-quantity');
        if (qtySpan) {
          const currentQtyText = qtySpan.textContent.replace('Stock: ', '');
          let currentQty = parseInt(currentQtyText, 10);
          
          if (!isNaN(currentQty)) {
            let newQty = currentQty - item.qty;
            qtySpan.textContent = `Stock: ${newQty}`;
            productCard.dataset.stock = newQty;
          }
        }
      }
    }
  }

  // --- REPLACE the old function with this new one ---
  function generateReceipt(cart, total, cash, change, receiptNumber, vatAmount) {
    // Helper function for date/time
    const now = new Date();
    const dateStr = now.toLocaleDateString();
    const timeStr = now.toLocaleTimeString();

    // Start building the HTML string
    let html = `<div class="receipt-header">`;
    html += `<h5>${receiptNumber || 'INVOICE'}</h5>`; // Use INVOICE label by default
    html += `<small>Date: ${dateStr} ${timeStr}</small>`;
    html += `</div>`;
    
    html += `<hr>`;
    
    // Add placeholders for manual entry
    html += `<div class="receipt-field"><strong>Customer:</strong> <span></span></div>`;
    html += `<div class="receipt-field"><strong>TIN:</strong> <span></span></div>`;
    html += `<div class="receipt-field"><strong>Address:</strong> <span></span></div>`;
    
    html += `<hr>`;
    
    // Items Header
    html += `<div class="receipt-items-header">`;
    html += `<span class="item-name">Item</span>`;
    html += `<span class="item-qty">Qty x Price</span>`;
    html += `<span class="item-total">Total</span>`;
    html += `</div>`;
    
    // Item Lines
    cart.forEach(i => {
      html += `<div class="receipt-item">`;
      html += `<span class="item-name">${i.name}</span>`;
      html += `<span class="item-qty">${i.qty} × ${i.price.toFixed(2)}</span>`;
      html += `<span class="item-total">₱${(i.qty * i.price).toFixed(2)}</span>`;
      html += `</div>`;
    });
    
    html += `<hr>`;
    
    // Totals
    // Calculate VATable Sales (Total minus VAT)
    const vatableSales = total - (vatAmount || 0); 
    
    html += `<div class="receipt-totals">`;
    html += `<div style="font-weight: normal; font-size: 1rem;"><span>VATable Sales:</span> <span>₱${vatableSales.toFixed(2)}</span></div>`;
    html += `<div style="font-weight: normal; font-size: 1rem;"><span>VAT (12%):</span> <span>₱${(vatAmount || 0).toFixed(2)}</span></div>`;
    
    html += `<div><span>TOTAL:</span> <span>₱${total.toFixed(2)}</span></div>`;
    html += `<div><span>CASH:</span> <span>₱${cash.toFixed(2)}</span></div>`;
    html += `<div><span>CHANGE:</span> <span>₱${change.toFixed(2)}</span></div>`;
    html += `</div>`;
    
    html += `<hr>`;
    
    // Signature placeholder
    html += `<div class"receipt-footer" style="margin-top: 25px;">`;
    html += `<div class="receipt-field"><strong>Signature:</strong> <span></span></div>`;
    html += `<p style="text-align: center; font-size: 13px; margin-top: 20px;">Thank you!</p>`;
    html += `</div>`;
    
    return html;
  }

// --- ADD THIS NEW LISTENER FOR THE PRINT BUTTON ---
  document.getElementById('printReceiptBtn').addEventListener('click', function() {
    const receiptHtml = document.getElementById('receiptTemplate').innerHTML;
    
    // Open a new window
    const printWindow = window.open('', '', 'height=600,width=450');
    
    printWindow.document.write('<html><head><title>Print Receipt</title>');
    printWindow.document.write('<style>');
    // Embed the exact styles needed for the receipt to print correctly
    printWindow.document.write(`
      body {
        font-family: 'Courier New', Courier, monospace;
        margin: 15px;
        font-size: 14px;
        color: #000;
      }
      hr {
        border-top: 1px dashed #000;
        margin: 10px 0;
      }
      .receipt-header {
        text-align: center;
        margin-bottom: 10px;
      }
      .receipt-header h5 {
        margin: 0;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 1.2rem;
      }
      .receipt-header small { font-size: 13px; }
      .receipt-field {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        border-bottom: 1px dotted #777;
      }
      .receipt-field strong { margin-right: 10px; }
      .receipt-items-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        border-bottom: 1px solid #000;
        margin-top: 15px;
      }
      .receipt-item {
        display: flex;
        margin-top: 5px;
      }
      .receipt-item .item-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .receipt-item .item-qty, .receipt-item .item-total {
        text-align: right;
      }
      .receipt-item .item-qty { width: 70px; }
      .receipt-item .item-total { width: 90px; }
      .receipt-totals {
        margin-top: 15px;
      }
      .receipt-totals div {
        display: flex;
        justify-content: space-between;
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      /* Style fix for the VAT lines */
      .receipt-totals div[style*="font-weight: normal"] {
        font-weight: normal !important;
        font-size: 1rem !important;
      }
      .receipt-footer { margin-top: 25px; }
    `);
    printWindow.document.write('</style></head><body>');
    // Write the receipt content
    printWindow.document.write(receiptHtml);
    printWindow.document.write('</body></html>');
    
    printWindow.document.close();
    printWindow.focus();
    
    // Use a small timeout to ensure content is loaded before triggering print
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 250);
  });
  // --- END OF NEW LISTENER ---

}); // --- END of DOMContentLoaded wrapper ---
</script>
{% endblock %}